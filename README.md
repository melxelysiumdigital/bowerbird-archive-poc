# Bowerbird Archive POC

Monorepo for the Bowerbird Archive proof of concept — a Next.js website, Shopify embedded app, and Shopify theme with a shared component library.

## Prerequisites

- [Node.js](https://nodejs.org/) >= 25
- [pnpm](https://pnpm.io/) 9.15.0

## Getting Started

```bash
pnpm install
```

## Workspaces

| Workspace                          | Path                         | Description                                         |
| ---------------------------------- | ---------------------------- | --------------------------------------------------- |
| `@bowerbird-poc/web`               | `apps/web`                   | Next.js headless storefront (port 3000)             |
| `@bowerbird-poc/shopify-app`       | `apps/shopify-donations`     | Shopify embedded app — donations (port 3001)        |
| `@bowerbird-poc/shopify-theme`     | `apps/shopify-theme`         | Shopify theme with Vite build pipeline              |
| `@bowerbird-poc/shopify-thank-you` | `apps/shopify-thank-you`     | Shopify app — checkout thank-you redirect extension |
| `@bowerbird-poc/ui`                | `packages/ui`                | Shared shadcn/ui component library                  |
| `@bowerbird-poc/shared`            | `packages/shared`            | Shared types, constants, and utilities              |
| `@bowerbird-poc/eslint-config`     | `packages/eslint-config`     | Shared ESLint flat config                           |
| `@bowerbird-poc/stylelint-config`  | `packages/stylelint-config`  | Shared Stylelint config                             |
| `@bowerbird-poc/typescript-config` | `packages/typescript-config` | Shared TypeScript configs                           |

## Scripts

### Development

```bash
# Start all apps in dev mode
pnpm dev

# Start individual apps
pnpm dev:web
pnpm dev:shopify-app
pnpm dev:shopify-theme
```

The Shopify theme has a two-process dev workflow:

```bash
cd apps/shopify-theme

# Terminal 1 — Vite watches and rebuilds TS/CSS into theme/assets/
pnpm dev

# Terminal 2 — Shopify CLI serves the theme
pnpm theme:dev
```

### Build & Validate

```bash
pnpm build          # Build all workspaces
pnpm type-check     # TypeScript check across all workspaces
pnpm lint           # ESLint across all workspaces
pnpm lint:fix       # Auto-fix lint issues
pnpm format:check   # Check Prettier formatting
pnpm format         # Auto-format all files
```

### Cleanup

```bash
pnpm clean          # Remove build artifacts and node_modules
```

## Adding shadcn/ui Components

Components are installed into `packages/ui/src/components/` and shared across all apps. Always run the CLI from an app directory:

```bash
cd apps/web
pnpm dlx shadcn@latest add dialog
```

The CLI reads the app's `components.json`, which points component output to `packages/ui`. After adding, import from any app:

```tsx
import { Dialog } from '@bowerbird-poc/ui/components/dialog';
```

App-specific composed components should live in each app's own `components/` directory.

## Tailwind CSS

Tailwind v4 is configured with a single source of truth at `packages/ui/src/styles/globals.css`. This file uses `@source` directives to scan all apps for class usage.

Each app's CSS simply imports the shared styles:

```css
@import '@bowerbird-poc/ui/globals.css';
```

## Shopify Theme

The theme at `apps/shopify-theme/theme/` is based on [Dawn](https://github.com/Shopify/dawn) (Shopify's reference theme) with React component support via Vite. It follows the standard Shopify directory structure (layout, sections, snippets, templates, config, locales, assets).

Vite compiles `src/entries/*.ts` and `src/entries/*.css` into `theme/assets/` with stable filenames (`react.bundle.js`, `react.min.css`, `theme.bundle.js`, `theme.min.css`). These build outputs are **gitignored** and generated by CI — they should never be committed.

```bash
cd apps/shopify-theme

pnpm theme:push     # Push theme to Shopify
pnpm theme:pull     # Pull theme from Shopify
```

The theme uses `@bowerbird-poc/ui` React components (HeroBanner, ProductCard) mounted via a Liquid snippet system, and `@bowerbird-poc/shared` for utilities.

## Headless Checkout Flow

The web app (`apps/web`) is a headless storefront — customers browse products there but checkout happens on Shopify. The Shopify app in `apps/shopify-thank-you` handles the entire redirect flow via two extensions:

### 1. `headless-redirect` theme app extension (storefront redirect)

A theme app extension (app embed) injected into the store `<head>`. Handles the full cookie-based redirect cycle:

1. **Checkout redirect**: Web app sends customer to `https://store.myshopify.com/?headless_origin=<origin>&checkout_url=<checkout_url>`. The script saves `headless_origin` as a cookie and redirects to checkout.
2. **Post-checkout redirect**: After purchase, any link back to the store triggers the script, which reads the cookie and redirects back to the headless app.

No theme file modifications needed — the extension is installed by enabling the app embed in the Shopify admin (Online Store > Themes > Customize > App embeds).

### 2. `thank-you-redirect` checkout UI extension (thank-you page)

A Preact-based checkout UI extension that renders a "Continue to Your Order" button on the thank-you page with order details (`order_id`, `order_number`). Reads `headless_origin` from cart/line item attributes.

### Password-protected stores

The system password page (shown on dev stores) doesn't render theme code or app extensions. The store password must be entered in the browser first. Once authenticated, app extensions load and the redirect works.

### Setup

1. Deploy the app: `cd apps/shopify-thank-you && pnpm deploy`
2. Enable the "Headless Redirect" app embed: Online Store > Themes > Customize > App embeds
3. The redirect only acts when `headless_origin` params or cookies exist — direct Shopify customers are unaffected

## Deployment

A GitHub Actions workflow (`.github/workflows/deploy.yml`) handles theme deployment:

1. Builds the full monorepo (`pnpm build`) — generates Vite assets
2. Syncs only the `theme/` directory (respecting `.shopifyignore`) to a deployment branch
3. Pushes to `deploy/shopify-test` (on merge to main) or `deploy/shopify-prod` (manual dispatch)

Deployment branches contain only Shopify-ready theme files — no source code, node_modules, or build tooling. Connect the deploy branch to Shopify's GitHub integration for automatic theme updates.

Manual deployment via workflow dispatch supports `test`, `production`, and `custom` branch targets.

### Non-destructive sync

Deploys preserve changes made through the Shopify admin (template customizations, theme settings). The workflow uses a two-pass rsync instead of a full branch replacement:

| Category                                | Behavior                                                                                           | Examples                                                                                  |
| --------------------------------------- | -------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- |
| **Fully synced** (old files cleaned up) | Overwritten every deploy                                                                           | `assets/`, `sections/`, `snippets/`, `layout/`, `locales/`, `config/settings_schema.json` |
| **New only** (never overwritten)        | Repo templates are copied on first deploy; Shopify admin edits are preserved on subsequent deploys | `templates/**`                                                                            |
| **Excluded entirely**                   | Never touched by deploys; managed only via Shopify admin                                           | `config/settings_data.json`                                                               |

This means you can safely customize templates and theme settings in the Shopify admin without losing them on the next deploy.

## Project Structure

```
bowerbird-archive-poc/
├── apps/
│   ├── web/               # Next.js headless storefront
│   ├── shopify-donations/ # Shopify embedded app (donations)
│   ├── shopify-thank-you/ # Shopify app (checkout extension)
│   └── shopify-theme/     # Shopify theme + Vite
├── packages/
│   ├── ui/                # Shared shadcn/ui components
│   ├── shared/            # Shared types, constants, utils
│   ├── eslint-config/     # ESLint configs
│   ├── stylelint-config/  # Stylelint config
│   └── typescript-config/ # TypeScript configs
├── turbo.json             # Turborepo task orchestration
├── pnpm-workspace.yaml    # Workspace definitions
└── package.json           # Root scripts and tooling
```
